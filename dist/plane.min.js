(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.plane=b()})(this,function(){'use strict';function a(a){const b=` ${N.join(' ')} `;return 0<=b.indexOf(` ${a} `)}function b(a){return /[0-9]/i.test(a)}function c(a){return /[a-z]/i.test(a)}function d(a){return c(a)||0<=R.join('').indexOf(a)}function e(a){return 0<=O.join('').indexOf(a)}function f(a){return 0<=P.join('').indexOf(a)}function g(a){return 0<=Q.join('').indexOf(a)}function h(a,b,c=''){if(!a.eof()&&b(a.peek())){const d=c+a.next();return h(a,b,d)}return c}function i(a){let c=!1;const d=h(a,(a)=>{return'.'===a?!c&&(c=!0,!0):b(a)});return{type:'num',value:parseFloat(d)}}function j(b){const c=h(b,d),e=a(c)?'keyword':'const';return{type:e,value:c}}function k(a,b){let c=!1,d='';for(a.next();!a.eof();){const e=a.next();if(c)d+=e,c=!1;else if('\\'===e)c=!0;else if(e===b)break;else d+=e}return d}function l(a){const b=k(a,'"');return{type:'str',value:b}}function m(a){h(a,(a)=>'\n'!==a),a.next()}function n(a){if(h(a,g),a.eof())return null;const d=a.peek();return'#'===d?(m(a),n(a)):'"'===d?l(a):b(d)?i(a):c(d)?j(a):f(d)?{type:'punc',value:a.next()}:e(d)?{type:'op',value:h(a,e)}:a.fail(`Unable to process character: ${d}`)}function o(a){function b(){return c||(c=n(a))}let c=null;return{next:function(){const b=c;return c=null,b||n(a)},peek:b,eof:function(){return null===b()},fail:a.fail}}function p(a,b){const c=a.peek();return c&&'punc'===c.type&&(!b||c.value===b)&&c}function q(a,b){const c=a.peek();return c&&'keyword'===c.type&&(!b||c.value===b)&&c}function r(a,b){const c=a.peek();return c&&'op'===c.type&&(!b||c.value===b)&&c}function s(a,b){p(a,b)?a.next():a.fail(`Expecting punctuation: ${b}`)}function t(a,b){q(a,b)?a.next():a.fail(`Expecting keyword: "${b}"`)}function u(a){a.fail(`Unexpected token: ${JSON.stringify(a.peek())}`)}function v(b,c,d,e,f){const g=[];let a=!0;for(s(b,c);!b.eof()&&!p(b,d)&&(a?a=!1:s(b,e),!p(b,d));)g.push(f(b));return s(b,d),g}function w(a){const b=a.next();return'const'!==b.type&&a.fail('Expecting constant name'),b.value}function x(a,b){const c=v(a,'(',')',',',G);return{type:'call',func:b,args:c}}function y(a){const b='true'===a.next().value;return{type:'bool',value:b}}function z(a,b){const c=b();return p(a,'(')?x(a,c):c}function A(a){const b=v(a,'(',')',',',w),c=G(a);return{type:'fn',constants:b,body:c}}function B(a){t(a,'if');const b=G(a),c=G(a),d={type:'if',condition:b,then:c};return q(a,'else')?(a.next(),Object.assign({},d,{else:G(a)})):d}function C(a){const b=v(a,'{','}',';',G);return 0===b.length?T:1===b.length?b[0]:{type:'prog',prog:b}}function D(a,b){return b(a,()=>{if(p(a,'(')){a.next();const b=G(a);return s(a,')'),b}if(p(a,'{'))return C(a);if(q(a,'if'))return B(a);if(q(a,'true')||q(a,'false'))return y(a);if(q(a,'fn'))return a.next(),A(a);const b=a.next();return'const'===b.type||'num'===b.type||'str'===b.type?b:u(a)})}function E(a,b,c){const d=r(a);if(d){const e=S[d.value];if(e>c){a.next();const f='='===d.value?'assign':'binary',g=E(a,D(a,z),e);return E(a,{type:f,left:b,operator:d.value,right:g},c)}}return b}function F(a,b){if(a.eof())return b;const c=b.concat([G(a)]);return s(a,';'),F(a,c)}function G(a){return z(a,()=>E(a,D(a,z),0))}function H(a,b=F){const c=b(a,[]);return{type:'prog',prog:c}}function I(a,b){return Object.prototype.hasOwnProperty.call(a.constants,b)?a:'undefined'!=typeof a.parent&&I(a.parent,b)}function J(a,b,c){switch(a){case'+':return W(b)+W(c);case'-':return W(b)-W(c);case'*':return W(b)*W(c);case'/':return W(b)/X(c);case'%':return W(b)%X(c);case'**':return W(b)**W(c);case'&&':return!1!==b&&c;case'||':return!1===b?c:b;case'<':return W(b)<W(c);case'>':return W(b)>W(c);case'<=':return W(b)<=W(c);case'>=':return W(b)>=W(c);case'==':return b===c;case'!=':return b!==c;case'|>':return c(b);default:throw new Error(`Unable to process operator ${a}`);}}function K(a,b,c){const d=b.constants,e=a.extend();return function(...a){let f=0;return d.forEach((b)=>{e.set(b,!!(f<a.length)&&a[f]),f+=1}),c(b.body,e)}}function L(a,b){switch(a.type){case'num':case'str':case'bool':return a.value;case'const':return b.get(a.value);case'assign':{if('const'!==a.left.type)throw new Error(`Cannot assign to ${JSON.stringify(a.left)}`);return b.set(a.left.value,L(a.right,b))}case'binary':{const c=L(a.left,b),d=L(a.right,b);return J(a.operator,c,d)}case'fn':return K(b,a,L);case'if':{const c=L(a.condition,b);return!1===c?!!a.else&&L(a.else,b):L(a.then,b)}case'prog':{let c=!1;return a.prog.forEach((a)=>{c=L(a,b)}),c}case'call':{const c=L(a.func,b);return c(...a.args.map((a)=>L(a,b)))}default:throw new Error(`Unable to process expression: ${a.type}`);}}var M=function(a){let b=0,c=1,d=0;const e=()=>a.charAt(b);return{next:()=>{const e=a.charAt(b);return b+=1,'\n'===e?(c+=1,d=0):d+=1,e},peek:e,eof:()=>''===e(),fail:(a)=>{throw new Error(`${a} (${c}:${d})`)}}};const N=['if','else','fn','true','false'],O=['+','-','*','/','%','=','&','|','<','>','!'],P=['',',',';','(',')','{','}','[',']',''],Q=[' ','\t','\n'],R=['?','!','-','<','>','=','0','1','2','3','4','5','6','7','8','9'],S={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"|>":8,"+":10,"-":10,"*":20,"/":20,"%":20,"**":30},T={type:'bool',value:!1};var U=function(a){a.set('log',(a)=>console.log(a))};class V{constructor(a){this.constants=Object.create(null),this.parent=a,U(this)}extend(){const a=new V(this);return a}lookup(a){const b=I(this,a);return b}get(a){const b=this.lookup(a);if(!1!==b)return b.constants[a];throw new Error(`Undefined constant: "${a}"`)}set(a,b){if(this.constants[a])throw new Error(`Attempting to reassign constant: "${a}"`);return this.constants[a]=b,this}}const W=(a)=>{if('number'!=typeof a)throw new Error(`Expected number but got: "${a}"`);return a},X=(a)=>{if(0===W(a))throw new Error('Unable to divide number by zero');return a},Y=new V;return function(a){const b=M(a),c=o(b),d=H(c);L(d,Y)}});
