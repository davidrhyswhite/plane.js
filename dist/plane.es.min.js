var streamer=function(a){let b=0,c=1,d=0;const e=()=>a.charAt(b);return{next:()=>{const e=a.charAt(b);return b+=1,'\n'===e?(c+=1,d=0):d+=1,e},peek:e,eof:()=>''===e(),fail:(a)=>{throw new Error(`${a} (${c}:${d})`)}}};const KEYWORDS=['if','else','fn','true','false'],OPERATORS=['+','-','*','/','%','=','&','|','<','>','!'],PUNCTUATIONS=['',',',';','(',')','{','}','[',']',''],WHITESPACE=[' ','\t','\n'],NON_STARTING_IDENTIFIERS=['?','!','-','<','>','=','0','1','2','3','4','5','6','7','8','9'];function isKeyword(a){const b=` ${KEYWORDS.join(' ')} `;return 0<=b.indexOf(` ${a} `)}function isDigit(a){return /[0-9]/i.test(a)}function isIDStart(a){return /[a-z]/i.test(a)}function isID(a){return isIDStart(a)||0<=NON_STARTING_IDENTIFIERS.join('').indexOf(a)}function isOpChar(a){return 0<=OPERATORS.join('').indexOf(a)}function isPunc(a){return 0<=PUNCTUATIONS.join('').indexOf(a)}function isWhitespace(a){return 0<=WHITESPACE.join('').indexOf(a)}function readWhile(a,b,c=''){if(!a.eof()&&b(a.peek())){const d=c+a.next();return readWhile(a,b,d)}return c}function readNumber(a){let b=!1;const c=readWhile(a,(a)=>{return'.'===a?!b&&(b=!0,!0):isDigit(a)});return{type:'num',value:parseFloat(c)}}function readIdent(a){const b=readWhile(a,isID),c=isKeyword(b)?'keyword':'const';return{type:c,value:b}}function readEscaped(a,b){let c=!1,d='';for(a.next();!a.eof();){const e=a.next();if(c)d+=e,c=!1;else if('\\'===e)c=!0;else if(e===b)break;else d+=e}return d}function readString(a){const b=readEscaped(a,'"');return{type:'str',value:b}}function skipComment(a){readWhile(a,(a)=>'\n'!==a),a.next()}function readNext(a){if(readWhile(a,isWhitespace),a.eof())return null;const b=a.peek();return'#'===b?(skipComment(a),readNext(a)):'"'===b?readString(a):isDigit(b)?readNumber(a):isIDStart(b)?readIdent(a):isPunc(b)?{type:'punc',value:a.next()}:isOpChar(b)?{type:'op',value:readWhile(a,isOpChar)}:a.fail(`Unable to process character: ${b}`)}function lexer(a){function b(){return c||(c=readNext(a))}let c=null;return{next:function(){const b=c;return c=null,b||readNext(a)},peek:b,eof:function(){return null===b()},fail:a.fail}}function isPunc$1(a,b){const c=a.peek();return c&&'punc'===c.type&&(!b||c.value===b)&&c}function isKeyword$1(a,b){const c=a.peek();return c&&'keyword'===c.type&&(!b||c.value===b)&&c}function isOperator(a,b){const c=a.peek();return c&&'op'===c.type&&(!b||c.value===b)&&c}function skipPunc(a,b){isPunc$1(a,b)?a.next():a.fail(`Expecting punctuation: ${b}`)}function skipKeyword(a,b){isKeyword$1(a,b)?a.next():a.fail(`Expecting keyword: "${b}"`)}function unexpected(a){a.fail(`Unexpected token: ${JSON.stringify(a.peek())}`)}const PRECEDENCE={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"|>":8,"+":10,"-":10,"*":20,"/":20,"%":20,"**":30},FALSE={type:'bool',value:!1};function delimited(b,c,d,e,f){const g=[];let a=!0;for(skipPunc(b,c);!b.eof()&&!isPunc$1(b,d)&&(a?a=!1:skipPunc(b,e),!isPunc$1(b,d));)g.push(f(b));return skipPunc(b,d),g}function parseConstName(a){const b=a.next();return'const'!==b.type&&a.fail('Expecting constant name'),b.value}function parseCall(a,b){const c=delimited(a,'(',')',',',parseExpression);return{type:'call',func:b,args:c}}function parseBool(a){const b='true'===a.next().value;return{type:'bool',value:b}}function maybeCall(a,b){const c=b();return isPunc$1(a,'(')?parseCall(a,c):c}function parseLambda(a){const b=delimited(a,'(',')',',',parseConstName),c=parseExpression(a);return{type:'fn',constants:b,body:c}}function parseIf(a){skipKeyword(a,'if');const b=parseExpression(a),c=parseExpression(a),d={type:'if',condition:b,then:c};return isKeyword$1(a,'else')?(a.next(),Object.assign({},d,{else:parseExpression(a)})):d}function parseProg(a){const b=delimited(a,'{','}',';',parseExpression);return 0===b.length?FALSE:1===b.length?b[0]:{type:'prog',prog:b}}function parseAtom(a,b){return b(a,()=>{if(isPunc$1(a,'(')){a.next();const b=parseExpression(a);return skipPunc(a,')'),b}if(isPunc$1(a,'{'))return parseProg(a);if(isKeyword$1(a,'if'))return parseIf(a);if(isKeyword$1(a,'true')||isKeyword$1(a,'false'))return parseBool(a);if(isKeyword$1(a,'fn'))return a.next(),parseLambda(a);const b=a.next();return'const'===b.type||'num'===b.type||'str'===b.type?b:unexpected(a)})}function maybeBinary(a,b,c){const d=isOperator(a);if(d){const e=PRECEDENCE[d.value];if(e>c){a.next();const f='='===d.value?'assign':'binary',g=maybeBinary(a,parseAtom(a,maybeCall),e);return maybeBinary(a,{type:f,left:b,operator:d.value,right:g},c)}}return b}function makeTopLevel(a,b){if(a.eof())return b;const c=b.concat([parseExpression(a)]);return skipPunc(a,';'),makeTopLevel(a,c)}function parseExpression(a){return maybeCall(a,()=>maybeBinary(a,parseAtom(a,maybeCall),0))}function parse(a,b=makeTopLevel){const c=b(a,[]);return{type:'prog',prog:c}}var standardLib=function(a){a.set('log',(a)=>console.log(a))};function checkScope(a,b){return Object.prototype.hasOwnProperty.call(a.constants,b)?a:'undefined'!=typeof a.parent&&checkScope(a.parent,b)}class World{constructor(a){this.constants=Object.create(null),this.parent=a,standardLib(this)}extend(){const a=new World(this);return a}lookup(a){const b=checkScope(this,a);return b}get(a){const b=this.lookup(a);if(!1!==b)return b.constants[a];throw new Error(`Undefined constant: "${a}"`)}set(a,b){if(this.constants[a])throw new Error(`Attempting to reassign constant: "${a}"`);return this.constants[a]=b,this}}const num=(a)=>{if('number'!=typeof a)throw new Error(`Expected number but got: "${a}"`);return a},div=(a)=>{if(0===num(a))throw new Error('Unable to divide number by zero');return a};function applyOperator(a,b,c){switch(a){case'+':return num(b)+num(c);case'-':return num(b)-num(c);case'*':return num(b)*num(c);case'/':return num(b)/div(c);case'%':return num(b)%div(c);case'**':return num(b)**num(c);case'&&':return!1!==b&&c;case'||':return!1===b?c:b;case'<':return num(b)<num(c);case'>':return num(b)>num(c);case'<=':return num(b)<=num(c);case'>=':return num(b)>=num(c);case'==':return b===c;case'!=':return b!==c;case'|>':return c(b);default:throw new Error(`Unable to process operator ${a}`);}}function makeFunction(a,b,c){const d=b.constants,e=a.extend();return function(...a){let f=0;return d.forEach((b)=>{e.set(b,!!(f<a.length)&&a[f]),f+=1}),c(b.body,e)}}function evaluate(a,b){switch(a.type){case'num':case'str':case'bool':return a.value;case'const':return b.get(a.value);case'assign':{if('const'!==a.left.type)throw new Error(`Cannot assign to ${JSON.stringify(a.left)}`);return b.set(a.left.value,evaluate(a.right,b))}case'binary':{const c=evaluate(a.left,b),d=evaluate(a.right,b);return applyOperator(a.operator,c,d)}case'fn':return makeFunction(b,a,evaluate);case'if':{const c=evaluate(a.condition,b);return!1===c?!!a.else&&evaluate(a.else,b):evaluate(a.then,b)}case'prog':{let c=!1;return a.prog.forEach((a)=>{c=evaluate(a,b)}),c}case'call':{const c=evaluate(a.func,b);return c(...a.args.map((a)=>evaluate(a,b)))}default:throw new Error(`Unable to process expression: ${a.type}`);}}const world=new World;function run(a){const b=streamer(a),c=lexer(b),d=parse(c);evaluate(d,world)}export default run;
